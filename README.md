# Fedresurs Bankrot Parser (Java) — выгрузка банкротов в Excel

Этот проект — **прикладной парсер Федресурса (банкротства)**, который собирает данные по **юридическим лицам** и **физическим лицам** из API Федресурса и сохраняет результат в **Excel-файл** с двумя листами: **«ЮрЛица»** и **«ФизЛица»**. 

Цель проекта — получить **структурированный отчёт в формате XLSX** для дальнейшего анализа/проверки, а не “просто посмотреть JSON”.

---

## Что именно делает программа

### 1) Ходит в два источника (и это важно)
Проект использует **два разных backend-домена**, потому что данные разнесены по сервисам:

- `bankrot.fedresurs.ru` — отдаёт **списки банкротов** (пагинация, `pageData`, `lastLegalCase`) 
- `fedresurs.ru` — отдаёт **карточки сущностей** и дополнительные детали (companies/persons + публикации + торги) 

Почему нельзя брать всё из одного места?  
Потому что **список** (кто банкрот и номер дела) и **карточка** (ИНН/ОГРН/адрес/статусы/даты и т.д.) живут в разных API.

---

## Что получается на выходе

### Excel-файл
После выполнения создаётся файл в текущей папке проекта:

- `fedresurs_debtors_<timestamp>.xlsx` 

Внутри:
- лист **«ЮрЛица»**
- лист **«ФизЛица»** 

### Оформление Excel сделано “по-человечески”
Чтобы Excel был удобен для проверки:

- **закрепляется шапка** (freeze первой строки)  
- включаются **фильтры по колонкам** 
- шапка **жирная**, с фоном и границами 
- авто-подбор ширины колонок с ограничением максимума 
- сохранение файла сделано **надёжно**: сначала `.tmp`, потом атомарный `move` (чтобы не получать “битый” Excel при сбое) 

### Политика “нет данных = пустая ячейка”
Значения типа `н/д`, `-`, `null` автоматически нормализуются в **пусто**, чтобы Excel не засорялся заглушками. 

---

## Структура Excel (колонки на русском)

> Названия колонок берутся прямо из `Sheets.LEGAL_HEADERS` и `Sheets.PHYSICAL_HEADERS`. 

### Лист «ЮрЛица»
Колонки (в порядке выгрузки): 

1. Полное наименование  
2. ИНН  
3. ОГРН  
4. КПП  
5. Уставный капитал  
6. Дата регистрации  
7. Адрес  
8. Регион  
9. ОПФ (ОКОПФ)  
10. ОКВЭД  
11. Статус организации  
12. Процедура  
13. Номер дела  
14. Статус дела  
15. Дата завершения дела  
16. Арбитражный управляющий (ФИО)  
17. Арбитражный управляющий (ИНН)  
18. Дата назначения управляющего  
19. Кол-во публикаций  
20. Кол-во торгов  
21. Источник (URL)

### Лист «ФизЛица»
Колонки (в порядке выгрузки):

1. ФИО  
2. Предыдущее ФИО  
3. ИНН  
4. СНИЛС  
5. Дата рождения  
6. Место рождения  
7. Адрес проживания  
8. Регион  
9. ОГРНИП  
10. Статус ИП  
11. ОКВЭД  
12. Дата регистрации ИП  
13. Дата прекращения ИП  
14. Статус банкротства  
15. Процедура  
16. Номер дела  
17. Арбитражный управляющий (ФИО)  
18. Источник (URL)

---

## Как формируются ключевые поля (чтобы было понятно “почему так”)

### CaseEndDate (Дата завершения дела) — **только из карточки компании**
В проекте зафиксировано правило:  
**Дата завершения дела (caseEndDate) берётся только из `companies.status.date`**, то есть из карточки компании:

- запрос: `/backend/companies/{guid}`
- поле: `status.date`
- дальше приводится к `dd.MM.yyyy`, иначе `н/д` 
Это сделано специально, потому что:
- в `lastLegalCase` даты часто нет/нестабильны,
- в `/bankruptcy` может быть другая логика, и там легко “сломать” согласованность данных.

---

### TradesCount (Кол-во торгов)
Важно: торги **не живут** в старом пути `/cmpbankrupts/{guid}/trades`.  
Правильный источник торгов — это:

`/backend/biddings?bankruptGuid=...` 

Именно поэтому в проекте используется `biddingsByBankruptGuid(bankruptGuid, ...)`. 

---

### PreviousFullName (Предыдущее ФИО)
Алгоритм для физлиц устроен “бережно”:

1) Сначала пытаемся достать `nameHistories` и похожие поля из карточки `/backend/persons/{guid}` 
2) Если пусто — пробуем дополнительный endpoint `/backend/persons/{guid}/general-info` как fallback :
3) **Если всё равно пусто — ничего не придумываем и не подставляем.** Поле остаётся пустым (это принципиально). 

Почему так строго?  
Потому что “придумать” предыдущее ФИО нельзя: это не вычисляемое поле, и любая догадка будет фальсификацией данных.

---

## Запуск

### Вариант A (самый простой): IntelliJ IDEA
1. Открой проект в IntelliJ  
2. Убедись, что стоит JDK (обычно 17+)  
3. Открой `com.ain.bankrot.Main` и нажми **Run* 
4. После выполнения рядом появится Excel: `fedresurs_debtors_<timestamp>.xlsx` 

### Вариант B: через консоль (если проект собирается Maven/Gradle)
Проект использует обычную структуру Java-проекта (`Main.java` в `com.ain.bankrot`)
Команда зависит от того, чем он собран (Maven/Gradle). Если у тебя Maven-проект — можно запускать через IDE, это надёжнее и проще.

---

## Настройки количества выгружаемых записей и “бережный режим”

В `Main.java` есть параметры, которые **реально влияют на стабильность**:

- `needLegals` и `needPersons` — сколько строк выгружать 
- `pageSize` — размер страницы списка (меньше = мягче для API) 
- `SLEEP_MS` — пауза между запросами (снижает шанс антибот-ошибок типа 451/403)
- `DEBUG_PER_ITEM` и `DEBUG_ITEMS_LIMIT` — режим отладки, который специально ограничен, чтобы не устроить “шквал запросов” 

---

## Возможные нюансы (важно прочитать перед сдачей/защитой)

1) **«Предыдущее ФИО» часто пустое — это нормально.**  
   Это не ошибка парсера. Парсер честно пытается достать историю имён, но если Федресурс её не отдаёт, поле остаётся пустым.
   Дополнительно: ты вручную проверила — и у многих людей действительно **нет предыдущего ФИО** в источнике.

2)  **“нет данных” в Excel = пустая ячейка .**  
   Значения вроде `н/д`, `null`, `-` нормализуются в пусто, чтобы не мешать фильтрам и анализу. 

---

## Используемые библиотеки / технологии

- HTTP-клиент: **OkHttp** (таймауты настроены: call/read 40s, connect 15s)
- JSON: **Jackson (ObjectMapper)** 
- Excel: **Apache POI (XSSFWorkbook)** 

---

## Примечание по ответственности

Проект предназначен для учебных/аналитических задач. Данные берутся из публичных API Федресурса и могут изменяться со временем. При массовой выгрузке соблюдай разумные лимиты и паузы, чтобы не перегружать сервис.

---

## Лицензия
(по желанию) MIT / Apache-2.0 / или оставить без лицензии для учебного проекта.
